/**
 * рЃбрЃћрЃАрЃбрЃў 1: рЃњрЃарЃљрЃЏрЃљрЃбрЃўрЃЎрЃБрЃџрЃў рЃАрЃўрЃќрЃБрЃАрЃбрЃћ
 * рЃбрЃћрЃАрЃбрЃљрЃЋрЃА рЃњрЃБрЃарЃБрЃџрЃЮрЃА рЃњрЃарЃљрЃЏрЃљрЃбрЃўрЃЎрЃБрЃџ рЃАрЃўрЃќрЃБрЃАрЃбрЃћрЃА рЃАрЃљрЃБрЃЉрЃљрЃарЃерЃў
 */

const axios = require('axios');

const AI_SERVICE_URL = 'https://backend.ai.bakhmaro.co';

const GRAMMAR_TEST_PROMPTS = [
  {
    prompt: "рЃЏрЃЮрЃЏрЃўрЃДрЃћрЃЋрЃў рЃарЃЮрЃњрЃЮрЃа рЃЋрЃљрЃЎрЃћрЃЌрЃћрЃЉ рЃЎрЃћрЃЦрЃАрЃА рЃАрЃљрЃ«рЃџрЃерЃў",
    expectedGrammar: "рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА рЃњрЃарЃљрЃЏрЃљрЃбрЃўрЃЎрЃБрЃџрЃљрЃЊ рЃАрЃгрЃЮрЃарЃў рЃЦрЃљрЃарЃЌрЃБрЃџрЃў рЃбрЃћрЃЦрЃАрЃбрЃў"
  },
  {
    prompt: "рЃарЃљ рЃљрЃарЃўрЃА рЃърЃарЃЮрЃњрЃарЃљрЃЏрЃўрЃарЃћрЃЉрЃљ рЃЊрЃљ рЃарЃљрЃбрЃЮрЃЏ рЃљрЃарЃўрЃА рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃљрЃюрЃў",
    expectedGrammar: "рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА рЃњрЃарЃљрЃЏрЃљрЃбрЃўрЃЎрЃБрЃџрЃљрЃЊ рЃАрЃгрЃЮрЃарЃў рЃЦрЃљрЃарЃЌрЃБрЃџрЃў рЃбрЃћрЃЦрЃАрЃбрЃў"
  },
  {
    prompt: "рЃљрЃ«рЃАрЃћрЃюрЃў рЃарЃЮрЃњрЃЮрЃа рЃЏрЃБрЃерЃљрЃЮрЃЉрЃА рЃўрЃюрЃбрЃћрЃарЃюрЃћрЃбрЃў",
    expectedGrammar: "рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА рЃњрЃарЃљрЃЏрЃљрЃбрЃўрЃЎрЃБрЃџрЃљрЃЊ рЃАрЃгрЃЮрЃарЃў рЃЦрЃљрЃарЃЌрЃБрЃџрЃў рЃбрЃћрЃЦрЃАрЃбрЃў"
  },
  {
    prompt: "рЃарЃљ рЃљрЃарЃўрЃА AI рЃЊрЃљ рЃарЃЮрЃњрЃЮрЃа рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћрЃЉрЃљ рЃЊрЃдрЃћрЃА",
    expectedGrammar: "рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА рЃњрЃарЃљрЃЏрЃљрЃбрЃўрЃЎрЃБрЃџрЃљрЃЊ рЃАрЃгрЃЮрЃарЃў рЃЦрЃљрЃарЃЌрЃБрЃџрЃў рЃбрЃћрЃЦрЃАрЃбрЃў"
  },
  {
    prompt: "рЃЏрЃЮрЃЏрЃўрЃДрЃћрЃЋрЃў рЃерЃћрЃюрЃў рЃЊрЃдрЃўрЃА рЃерЃћрЃАрЃљрЃ«рЃћрЃЉ",
    expectedGrammar: "рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА рЃњрЃарЃљрЃЏрЃљрЃбрЃўрЃЎрЃБрЃџрЃљрЃЊ рЃАрЃгрЃЮрЃарЃў рЃЦрЃљрЃарЃЌрЃБрЃџрЃў рЃбрЃћрЃЦрЃАрЃбрЃў"
  }
];

async function testGrammarCorrectness() {
  console.log('­ЪЊЮ рЃЊрЃљрЃгрЃДрЃћрЃЉрЃљ: рЃњрЃарЃљрЃЏрЃљрЃбрЃўрЃЎрЃБрЃџрЃў рЃАрЃўрЃќрЃБрЃАрЃбрЃўрЃА рЃбрЃћрЃАрЃбрЃў\n');

  let totalTests = 0;
  let grammarErrors = 0;

  for (const testPrompt of GRAMMAR_TEST_PROMPTS) {
    console.log(`­Ъњг рЃърЃарЃЮрЃЏрЃърЃбрЃў: "${testPrompt.prompt}"`);

    try {
      const startTime = Date.now();

      const response = await axios.post(`${AI_SERVICE_URL}/api/ai/chat`, {
        message: testPrompt.prompt,
        userId: 'grammar_test_user'
      });

      const endTime = Date.now();
      const responseTime = endTime - startTime;

      console.log(`РюЁ рЃърЃљрЃАрЃБрЃ«рЃў рЃЏрЃўрЃдрЃћрЃЉрЃБрЃџрЃўрЃљ ${responseTime}ms-рЃерЃў`);
      console.log(`­ЪЊЮ рЃърЃљрЃАрЃБрЃ«рЃў: ${response.data.response.substring(0, 300)}...`);

      if (response.data.success) {
        totalTests++;

        // рЃњрЃарЃљрЃЏрЃљрЃбрЃўрЃЎрЃБрЃџрЃў рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ (рЃЏрЃљрЃарЃбрЃўрЃЋрЃў рЃљрЃюрЃљрЃџрЃўрЃќрЃў)
        const responseText = response.data.response;

        // рЃерЃћрЃљрЃЏрЃЮрЃгрЃЏрЃћ рЃФрЃўрЃарЃўрЃЌрЃљрЃЊрЃў рЃњрЃарЃљрЃЏрЃљрЃбрЃўрЃЎрЃБрЃџрЃў рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃћрЃЉрЃў
        let errors = 0;

        // 1. рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћ рЃгрЃћрЃарЃбрЃўрЃџрЃћрЃЉрЃў рЃЊрЃљ рЃЏрЃФрЃўрЃЏрЃћрЃћрЃЉрЃў
        const sentences = responseText.split(/[.!?]/);
        sentences.forEach(sentence => {
          const trimmed = sentence.trim();
          if (trimmed.length > 0) {
            // рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћ рЃЊрЃўрЃЊрЃў рЃљрЃАрЃЮрЃћрЃЉрЃўрЃА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃљ
            if (!/^[рЃљ-рЃ░]/.test(trimmed) && trimmed.length > 1) {
              errors++;
            }
          }
        });

        // 2. рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћ рЃњрЃарЃФрЃћрЃџрЃў рЃгрЃўрЃюрЃљрЃЊрЃљрЃЊрЃћрЃЉрЃћрЃЉрЃў (рЃерЃћрЃАрЃљрЃФрЃџрЃЮрЃљ рЃњрЃљрЃБрЃњрЃћрЃЉрЃљрЃарЃў рЃўрЃДрЃЮрЃА)
        const longSentences = responseText.split(/[.!?]/).filter(s => s.trim().split(' ').length > 25);
        errors += longSentences.length;

        // 3. рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћ рЃњрЃљрЃюрЃЏрЃћрЃЮрЃарЃћрЃЉрЃћрЃЉрЃў
        const words = responseText.toLowerCase().split(/\s+/);
        const wordCount = {};
        words.forEach(word => {
          if (word.length > 3) { // рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃњрЃарЃФрЃћрЃџрЃў рЃАрЃўрЃбрЃДрЃЋрЃћрЃЉрЃў
            wordCount[word] = (wordCount[word] || 0) + 1;
          }
        });
        const repeatedWords = Object.values(wordCount).filter(count => count > 3).length;
        errors += repeatedWords;

        if (errors > 0) {
          grammarErrors++;
          console.log(`РЮї рЃњрЃарЃљрЃЏрЃљрЃбрЃўрЃЎрЃБрЃџрЃў рЃерЃћрЃфрЃЊрЃЮрЃЏрЃћрЃЉрЃў рЃљрЃдрЃЏрЃЮрЃЕрЃћрЃюрЃўрЃџрЃў: ${errors}`);
        } else {
          console.log(`РюЁ рЃњрЃарЃљрЃЏрЃљрЃбрЃўрЃЎрЃБрЃџрЃљрЃЊ рЃАрЃгрЃЮрЃарЃў`);
        }

      } else {
        console.log(`РЮї рЃЏрЃЮрЃЌрЃ«рЃЮрЃЋрЃюрЃљ рЃЕрЃљрЃЋрЃљрЃарЃЊрЃљ: ${response.data.error || 'рЃБрЃфрЃюрЃЮрЃЉрЃў рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ'}`);
      }

    } catch (error) {
      console.error(`РЮї рЃбрЃћрЃАрЃбрЃў рЃЕрЃљрЃЋрЃљрЃарЃЊрЃљ: ${error.message}`);
    }

    console.log('Рћђ'.repeat(80) + '\n');

    // рЃЊрЃљрЃДрЃЮрЃЋрЃюрЃћрЃЉрЃљ рЃбрЃћрЃАрЃбрЃћрЃЉрЃА рЃерЃЮрЃарЃўрЃА
    await new Promise(resolve => setTimeout(resolve, 2000));
  }

  // рЃерЃћрЃЊрЃћрЃњрЃћрЃЉрЃўрЃА рЃерЃћрЃ»рЃљрЃЏрЃћрЃЉрЃљ
  const successRate = totalTests > 0 ? ((totalTests - grammarErrors) / totalTests * 100).toFixed(1) : 0;

  console.log('­ЪЊі рЃњрЃарЃљрЃЏрЃљрЃбрЃўрЃЎрЃБрЃџрЃў рЃАрЃўрЃќрЃБрЃАрЃбрЃўрЃА рЃбрЃћрЃАрЃбрЃў рЃЊрЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃБрЃџрЃўрЃљ.');
  console.log(`­ЪЊѕ рЃАрЃБрЃџ рЃбрЃћрЃАрЃбрЃћрЃЉрЃў: ${totalTests}`);
  console.log(`РЮї рЃњрЃарЃљрЃЏрЃљрЃбрЃўрЃЎрЃБрЃџрЃў рЃерЃћрЃфрЃЊрЃЮрЃЏрЃћрЃЉрЃў: ${grammarErrors}`);
  console.log(`РюЁ рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃА рЃЏрЃљрЃЕрЃЋрЃћрЃюрЃћрЃЉрЃћрЃџрЃў: ${successRate}%`);

  if (successRate < 80) {
    console.log('Рџа№ИЈ рЃАрЃљрЃГрЃўрЃарЃЮрЃљ рЃњрЃарЃљрЃЏрЃљрЃбрЃўрЃЎрЃБрЃџрЃў рЃњрЃљрЃБрЃЏрЃ»рЃЮрЃЉрЃћрЃАрЃћрЃЉрЃљ!');
  } else {
    console.log('­ЪјЅ рЃњрЃарЃљрЃЏрЃљрЃбрЃўрЃЎрЃБрЃџрЃў рЃАрЃўрЃќрЃБрЃАрЃбрЃћ рЃЎрЃљрЃарЃњ рЃЊрЃЮрЃюрЃћрЃќрЃћрЃљ!');
  }
}

// рЃњрЃљрЃБрЃерЃЋрЃў рЃбрЃћрЃАрЃбрЃў
if (require.main === module) {
  testGrammarCorrectness().catch(console.error);
}

module.exports = { testGrammarCorrectness };
